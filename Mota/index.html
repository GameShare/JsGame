<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <title>MoTa</title>
    <script src='data.js'></script>
    <script type='text/javascript'>
        window.onload = function(){

            MoTaGame();
            console.log(map[2][11].downX)

            function MoTaGame(){

                var oYellowKey = document.getElementById("yellowKey");
                var oBlueKey = document.getElementById("blueKey");
                var oRedKey = document.getElementById("redKey");

                var oPlLife = document.getElementById("plLife");
                var oPlAttack = document.getElementById("plAttack");
                var oPlGuard = document.getElementById("plGuard");
                var oPlGold = document.getElementById("plGold");

                var oEnName = document.getElementById("enName");
                var oEnLife = document.getElementById("enLife");
                var oEnAttack = document.getElementById("enAttack");
                var oEnGuard = document.getElementById("enGuard");

                var oMessage = document.getElementById("message");

                // 在游戏中随时会变的参数
                var player = {
                    x:0,        // 主角的位置X
                    y:0,        // 主角的位置Y
                    dir:0,      // 主角的方向，1左，2上，3右，4下
                    life:0,     // 主角的生命值
                    attack:0,   // 主角的攻击力
                    guard:0,    // 主角的防御力
                    gold:0      // 主角的金币
                }

                // 敌方的数据信息，仅在战斗的时候启用
                var enemy = {
                    chsName:"", 
                    life:"",
                    attack:"",
                    guard:""
                }

                var currentFloor;       // 当前楼层

                var key = {
                    yellowKey  :0,              // 黄钥匙的数量
                    blueKey    :0,              // 蓝钥匙的数量
                    redKey     :0               // 蓝钥匙的数量
                }


                // 在游戏中理论上不会变的参数
                var doorSpeed = 50;     // 开关门的速度
                var battleSpeed = 200;  // 战斗中一次攻击的速度


                var moveFlag = 1;        // 判断是否可以进行操作，1 代表可以， 0 代表不可以
                var battleFlag = 0;      // 是否刚进行或打算进行一场战斗，1 代表是，0 代表不是。若为 1 ，则应该在下一次移动中刷新数据，并将该变量归0

                creatTable();
                init();
                drawFloor();
                gameStart();
                showData()

                function gameStart(){

                    // 这里 键盘事件 设置
                    document.onkeydown = function(event){

                        // 如果 moveFlag 为 0 ，则此时禁止任何操作
                        if(!moveFlag) return false;
                        var e = event || window.event || arguments.callee.caller.arguments[0];
                        if(e && e.keyCode==37||38||39||40){
                            // 主角的移动事件
                            playerMove(e && e.keyCode);
                        }

                    }
                }

                function init(){

                    // 当前楼层
                    currentFloor = 1;

                    player = {
                        x:10,
                        y:5,
                        dir:4,
                        life:1000,
                        attack:15,
                        guard:15,
                        gold:0 
                    }

                    key = {
                        yellowKey : 0,
                        blueKey   : 0,
                        redKey    : 0
                    }
                }

                // 在主角的移动过程中，必须要先进行判断，再进行移动
                function playerMove(dir){

                    //  如果刚进行或打算进行一场战斗，刷新屏幕数据
                    if(battleFlag){
                        showData();
                        battleFlag = 0;
                    }

                    // 主角应该前往的砖块
                    checkX = player.x;
                    checkY = player.y;

                    switch(dir){
                        case 37:checkY--;player.dir = 1;break;
                        case 38:checkX--;player.dir = 2;break;
                        case 39:checkY++;player.dir = 3;break;
                        case 40:checkX++;player.dir = 4;break;
                    }
                    if(checkMove()){
                        player.x = checkX;
                        player.y = checkY;
                    }

                    drawFloor();

                    // 判断是否可以移动，并执行若发生移动的事件
                    function checkMove(){
                        if(checkX < 0 || checkX > 10 || checkY < 0 || checkY > 10) return false;
                        switch(map[currentFloor][checkX][checkY].t){
                            case "none":return true;
                            case "wall":{
                                switch(map[currentFloor][checkX][checkY].f){
                                    case "normal":
                                    case "iconWall":
                                    return false;
                                    case "darkNormal":{
                                        openDoorAndWall(currentFloor, checkX, checkY);
                                        return false;
                                    }
                                }
                                break;
                            }
                            case "door":{
                                switch(map[currentFloor][checkX][checkY].f){
                                    case "locked":break;
                                    default:{
                                        // if 判断式里面的式子是钥匙剩余的数量，若大于0则判断为真
                                        // 如果 判断为真 则执行以下操作：开门 钥匙数量-1 改变屏幕上显示的参数
                                        if(key[doorData[map[currentFloor][checkX][checkY].f].require]){
                                            openDoorAndWall(currentFloor, checkX, checkY);
                                            key[doorData[map[currentFloor][checkX][checkY].f].require] -- ;
                                            showData();
                                            break;
                                        }
                                    }
                                }
                                return false;
                            }
                            // 如果是物品，则先根据物品类型加点，再将物品清除，显示加点后的数字，最后使人物移动
                            case "goods":{
                                var time = parseInt(currentFloor/10)+1;
                                switch(map[currentFloor][checkX][checkY].f){
                                    case "yellowKey":key.yellowKey ++ ;break;
                                    case "blueKey":key.blueKey ++ ;break;
                                    case "redKey":key.redKey ++ ;break;
                                    case "redLife":player.life += 50 * time ;break;
                                    case "blueLife":player.life += 200 * time ;break;
                                    case "redGem":player.attack += time ;break;
                                    case "blueGem":player.guard += time ;break;
                                }
                                map[currentFloor][checkX][checkY].t = "none";
                                showData();
                                return true;
                            }

                            case "enemy":{

                                battleFlag = 1;

                                // 将敌方的战斗信息显示到屏幕上
                                enemy.chsName = enemyData[map[currentFloor][checkX][checkY].f].chsName;
                                enemy.life = enemyData[map[currentFloor][checkX][checkY].f].life;
                                enemy.attack = enemyData[map[currentFloor][checkX][checkY].f].attack;
                                enemy.guard = enemyData[map[currentFloor][checkX][checkY].f].guard;

                                showData();

                                // 先行判断敌方防御和己方攻击的关系，若打不动，则返回false
                                if(enemyData[map[currentFloor][checkX][checkY].f].guard >= player.attack) {
                                    showMessage("你打不动他！")
                                    clearEnemyData()
                                    return false;
                                }
                                var tempPlayerLife = player.life;
                                var tempEnemyLife = enemyData[map[currentFloor][checkX][checkY].f].life;

                                // 进行战斗模拟，预估战斗结果
                                while(true){
                                    tempEnemyLife -= player.attack - enemyData[map[currentFloor][checkX][checkY].f].guard;
                                    if(tempEnemyLife < 0)break;
                                    tempPlayerLife -= enemyData[map[currentFloor][checkX][checkY].f].attack - player.guard < 0 ? 0 :enemyData[map[currentFloor][checkX][checkY].f].attack - player.guard;
                                    if(tempPlayerLife < 0)break;
                                }

                                if(tempPlayerLife < 0){
                                    showMessage("你的生命值太低，打不过他！")
                                    clearEnemyData()
                                    return false;
                                }

                                // 若经过判断可以打过，那么。。开打！！
                                while(true){
                                    moveFlag = 0;
                                    setTimeout(attackInBattle,battleSpeed)
                                    return true;
                                }

                                break;
                            }

                            case "stairs":{
                                switch(map[currentFloor][checkX][checkY].f){
                                    case "upStairs":{
                                        currentFloor ++;
                                        checkX = map[currentFloor][11].downX;
                                        checkY = map[currentFloor][11].downY;
                                        player.dir = 4;
                                        drawFloor();
                                        return true;
                                    }
                                    case "downStairs":{
                                        currentFloor --;
                                        checkX = map[currentFloor][11].upX;
                                        checkY = map[currentFloor][11].upY;
                                        player.dir = 4;
                                        drawFloor();
                                        return true;
                                    }
                                }
                            }

                        }

                        return true;
                    }

                    // 战斗中一次攻击的函数
                    // 其中，敌人先受到攻击，如果体力小于0，就将体力归0，并显示数据，再清除数据，在改变并重绘地图；如果体力值不为 0 ，则主角受到攻击，显示数据，并进行下一场战斗的计时
                    function attackInBattle(){
                        enemy.life -= player.attack - enemyData[map[currentFloor][checkX][checkY].f].guard;
                        if(enemy.life < 0){
                            enemy.life = 0;
                            player.gold += enemyData[map[currentFloor][checkX][checkY].f].gold;

                            showData();
                            clearEnemyData();

                            map[currentFloor][checkX][checkY].t = "none";
                            drawFloor();

                            moveFlag = 1;
                        }
                        else{
                            player.life -= enemyData[map[currentFloor][checkX][checkY].f].attack - player.guard < 0 ? 0 :enemyData[map[currentFloor][checkX][checkY].f].attack - player.guard;
                            showData();
                            setTimeout(attackInBattle,battleSpeed);
                        }
                    }

                    // 清除敌人数据
                    function clearEnemyData(){
                        enemy.chsName = "";
                        enemy.life = "";
                        enemy.attack = "";
                        enemy.guard = "";
                    }
                }



                // 重绘当前楼层
                function drawFloor(){
                    // console.log(enemyData[map[currentFloor][2][1].f].src);

                    // 绘制地图上 除主角以外 的基本信息
                    for(var i = 0; i < 11; i++){
                        for(var j = 0; j < 11; j++){
                            // console.log(currentFloor + '-' + i + '-' + j)
                            switch(map[currentFloor][i][j].t){
                                case "none" : {
                                    var newBk = "";
                                    addBkImage(i,j,newBk,0,0);
                                    break;
                                }
                                case "enemy": {
                                    // console.log(i+'-'+j);
                                    var newBk = "images/Characters/" +  enemyData[map[currentFloor][i][j].f].src;
                                    var offY = enemyData[map[currentFloor][i][j].f].offsetY;
                                    addBkImage(i,j,newBk,0,offY);
                                    break;
                                }
                                case "wall": {
                                    var newBk = "images/Characters/" +  wallData[map[currentFloor][i][j].f].src;
                                    var offX = wallData[map[currentFloor][i][j].f].offsetX;
                                    addBkImage(i,j,newBk,offX,0);
                                    break;
                                }
                                case "door": {
                                    var newBk = "images/Characters/" +  doorData[map[currentFloor][i][j].f].src;
                                    var offX = doorData[map[currentFloor][i][j].f].offsetX;
                                    addBkImage(i,j,newBk,offX,0);
                                    break;
                                }
                                case "goods":{
                                    var newBk = "images/Characters/" +  goodsData[map[currentFloor][i][j].f].src;
                                    var offX = goodsData[map[currentFloor][i][j].f].offsetX;
                                    addBkImage(i,j,newBk,offX,0);
                                    break;
                                }
                                case "stairs":{
                                    var newBk = "images/" + stairsData[map[currentFloor][i][j].f].src;
                                    addBkImage(i,j,newBk,0,0);
                                    break;
                                }
                                case "NPC":{
                                    var newBk = "images/Characters/" + NPCData[map[currentFloor][i][j].f].src;
                                    var offY = NPCData[map[currentFloor][i][j].f].offsetY;
                                    addBkImage(i,j,newBk,0,offY);
                                    break;
                                }
                                case "bigDealer":{
                                    var newBk = "images/Characters/" +  bigDealerData[map[currentFloor][i][j].f].src;
                                    var offX = bigDealerData[map[currentFloor][i][j].f].offsetX;
                                    addBkImage(i,j,newBk,offX,0);
                                    break;
                                }
                            }
                        }
                    }

                    // 绘制主角
                    var playerOffY;
                    switch(player.dir){
                        case 1: playerOffY = -33;break;
                        case 2: playerOffY = -99;break;
                        case 3: playerOffY = -66;break;
                        case 4: playerOffY = 0;break;
                    }
                    console.log(player.x+'-'+player.y);
                    var oToChange = document.getElementById(player.x+'-'+player.y);
                    oToChange.style.background = "url('images/Characters/Actor01-Braver01.png') 0 "+ playerOffY + "px no-repeat," + oToChange.style.background;


                    function addBkImage(i, j, bkImage, offX, offY){
                        var oToChange = document.getElementById(i+'-'+j);
                        oToChange.style.background = "url('" + newBk + "') " + offX + "px " + offY + "px no-repeat,url('images/Characters/Other09.png') 0px 0 no-repeat";
                    }

                }

                // 刷新屏幕上显示的基本数据
                function showData(){
                    oYellowKey.innerHTML = key.yellowKey;
                    oBlueKey.innerHTML = key.blueKey;
                    oRedKey.innerHTML = key.redKey;

                    oPlLife.innerHTML = player.life;
                    oPlAttack.innerHTML = player.attack;
                    oPlGuard.innerHTML = player.guard;
                    oPlGold.innerHTML = player.gold;

                    oEnName.innerHTML = enemy.chsName;
                    oEnLife.innerHTML = enemy.life;
                    oEnAttack.innerHTML = enemy.attack;
                    oEnGuard.innerHTML = enemy.guard;
                }

                // 芝麻开门、芝麻开墙 此函数 提供动画效果 和 动画结束后 将门或墙至零的效果
                function openDoorAndWall(currentFloor, i, j){

                    moveFlag = 0;

                    var oToChange = document.getElementById(i+'-'+j);
                    var pre = oToChange.style.background.match(/^url.*?px/)// url("images/Characters/Event01-Wall01.png") -32px
                    var after = oToChange.style.background.match(/ url.*?repeat$/) //  url("images/Characters/Other09.png") 0px 0px no-repeat

                    setTimeout(function(){
                        oToChange.style.background = pre[0] + " -32px no-repeat," + after[0];
                        setTimeout(function(){
                            oToChange.style.background = pre[0] + " -64px no-repeat," + after[0];
                            setTimeout(function(){
                                oToChange.style.background = pre[0] + " -96px no-repeat," + after[0];
                                setTimeout(function(){
                                    map[currentFloor][i][j].t = "none";
                                    oToChange.style.background = after[0];
                                    moveFlag = 1;
                                }, doorSpeed)
                            }, doorSpeed)
                        }, doorSpeed)
                    }, doorSpeed)
                }

                // 输出调试信息
                function showMessage(msg){
                    var dateTime = new Date();
                    oMessage.innerHTML = (dateTime.toLocaleString() + " " + msg + "<br>"); 
                }

                // 绘制初始表格
                function creatTable(){
                    // '+i+'-'+j+'
                    var oGameDiv = document.getElementById("gameDiv");
                    var table = '<table><tbody>';
                    for(var i = 0; i < 11; i++){
                        table += '<tr>';
                        for(var j = 0; j < 11; j++){
                            table += '<td id="' + i + '-' + j +'">'+i+'-'+j+'</td>';
                        }
                        table += '</tr>';
                    }
                    table += '</tbody></table>';
                    oGameDiv.innerHTML = table;
                }
            };


        }



        
    </script>
</head>
<style type="text/css">
    *{margin: 0;padding: 0;}
    table{border-collapse:collapse;margin: 0 auto 0 auto;border: 5px solid rgb(119,68,34)}
    td{width: 32px;height:32px;font-size: 10px;text-align: center;
        /*background: url("images/Characters/Event01-Wall02.png") -64px 0 no-repeat;*/
        }
</style>
<body>
    <div id='gameDiv'></div>
    <p>黄钥匙:<span id="yellowKey"></span></p>
    <p>蓝钥匙:<span id="blueKey"></span></p>
    <p>红钥匙:<span id="redKey"></span></p>
    <p>体力值:<span id="plLife"></span></p>
    <p>攻击:<span id="plAttack"></span></p>
    <p>防御:<span id="plGuard"></span></p>
    <p>金币:<span id="plGold"></span></p>
    <br>
    <p>敌名称:<span id="enName"></span></p>
    <p>敌体力值:<span id="enLife"></span></p>
    <p>敌攻击:<span id="enAttack"></span></p>
    <p>敌防御:<span id="enGuard"></span></p>
    <br>
    <p>信息栏：<span id="message"></span></p>
</body>
</html>